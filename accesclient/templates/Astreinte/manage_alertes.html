{% include 'navbar.html' %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Alertes Astreintes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .alertes-table-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin: 0;
        }

        .close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-primary {
            background: #667eea;
            color: white;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-bell"></i> Gestion des Alertes Astreintes</h1>
            <p>Configurez les règles de vérification automatique des astreintes</p>
        </div>

        <div id="alertMessage" class="alert"></div>

        <div class="alertes-table-container">
            <div class="table-header">
                <h2>Règles d'Alertes Configurées</h2>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> Nouvelle Alerte
                </button>
            </div>

            <table id="alertesTable">
                <thead>
                    <tr>
                        <th>Jour</th>
                        <th>Heure</th>
                        <th>Agence</th>
                        <th>Jours à surveiller</th>
                        <th>Emails</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alertesTableBody">
                    <!-- Données chargées dynamiquement -->
                </tbody>
            </table>

            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>Aucune alerte configurée</h3>
                <p>Commencez par créer votre première règle d'alerte</p>
                <button class="btn btn-primary" onclick="openAddModal()" style="margin-top: 20px;">
                    <i class="fas fa-plus"></i> Créer une Alerte
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier -->
    <div id="alerteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nouvelle Alerte</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="alerteForm">
                    <input type="hidden" id="alerteId">
                    
                    <div class="form-group">
                        <label for="jour">Jour de la semaine <span style="color: red;">*</span></label>
                        <select class="form-control" id="jour" required>
                            <option value="">-- Sélectionnez un jour --</option>
                            <option value="1">Dimanche</option>
                            <option value="2">Lundi</option>
                            <option value="3">Mardi</option>
                            <option value="4">Mercredi</option>
                            <option value="5">Jeudi</option>
                            <option value="6">Vendredi</option>
                            <option value="7">Samedi</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="heure">Heure de vérification <span style="color: red;">*</span></label>
                        <input type="time" class="form-control" id="heure" required>
                        <small class="help-text">L'heure à laquelle la vérification sera effectuée</small>
                    </div>

                    <div class="form-group">
                        <label for="agence">Agence <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="agence" required 
                               placeholder="Ex: Lyon, Paris, Marseille">
                    </div>

                    <div class="form-group">
                        <label for="date_surveiller">Jours à surveiller <span style="color: red;">*</span></label>
                        <input type="number" class="form-control" id="date_surveiller" 
                               min="0" required placeholder="Ex: 7">
                        <small class="help-text">Nombre de jours à partir de la date actuelle</small>
                    </div>

                    <div class="form-group">
                        <label for="email">Email(s) destinataire(s) <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="email" required 
                               placeholder="email1@exemple.com, email2@exemple.com">
                        <small class="help-text">Séparez plusieurs emails par des virgules</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button class="btn btn-success" onclick="saveAlerte()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <script>
        let alertes = [];
        let editingId = null;

        // Charger les alertes au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadAlertes();
        });

        // Charger les alertes depuis l'API
        function loadAlertes() {
            fetch('{% url "get_alertes_json" %}')
                .then(response => response.json())
                .then(data => {
                    alertes = data.alertes;
                    renderTable();
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des alertes:', error);
                    showAlert('Erreur lors du chargement des alertes', 'error');
                });
        }

        // Afficher les alertes dans le tableau
        function renderTable() {
            const tbody = document.getElementById('alertesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (alertes.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tbody.innerHTML = alertes.map(alerte => `
                <tr>
                    <td><span class="badge badge-primary">${alerte.jour_display}</span></td>
                    <td><i class="far fa-clock"></i> ${alerte.heure}</td>
                    <td><i class="fas fa-building"></i> ${alerte.agence}</td>
                    <td><i class="fas fa-calendar-alt"></i> ${alerte.date_surveiller || 'N/A'} jour(s)</td>
                    <td><i class="fas fa-envelope"></i> ${truncateEmail(alerte.email)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="editAlerte(${alerte.id})" title="Modifier">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn btn-danger" onclick="deleteAlerte(${alerte.id})" title="Supprimer">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Tronquer les emails pour l'affichage
        function truncateEmail(email) {
            if (email.length > 40) {
                return email.substring(0, 40) + '...';
            }
            return email;
        }

        // Ouvrir le modal pour ajouter une alerte
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Nouvelle Alerte';
            document.getElementById('alerteForm').reset();
            document.getElementById('alerteId').value = '';
            document.getElementById('alerteModal').classList.add('show');
        }

        // Modifier une alerte
        function editAlerte(id) {
            editingId = id;
            const alerte = alertes.find(a => a.id === id);
            
            if (!alerte) return;

            document.getElementById('modalTitle').textContent = 'Modifier l\'Alerte';
            document.getElementById('alerteId').value = alerte.id;
            document.getElementById('jour').value = alerte.jour;
            document.getElementById('heure').value = alerte.heure;
            document.getElementById('agence').value = alerte.agence;
            document.getElementById('date_surveiller').value = alerte.date_surveiller;
            document.getElementById('email').value = alerte.email;
            
            document.getElementById('alerteModal').classList.add('show');
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('alerteModal').classList.remove('show');
        }

        // Fermer le modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('alerteModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Sauvegarder une alerte
        function saveAlerte() {
            const form = document.getElementById('alerteForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                jour: parseInt(document.getElementById('jour').value),
                heure: document.getElementById('heure').value,
                agence: document.getElementById('agence').value,
                date_surveiller: parseInt(document.getElementById('date_surveiller').value),
                email: document.getElementById('email').value
            };

            const url = editingId 
                ? `{% url "update_alerte" 0 %}`.replace('0', editingId)
                : '{% url "create_alerte" %}';

            const method = 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert(result.message, 'success');
                    closeModal();
                    loadAlertes();
                } else {
                    showAlert('Erreur: ' + JSON.stringify(result.errors), 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showAlert('Erreur lors de la sauvegarde', 'error');
            });
        }

        // Supprimer une alerte
        function deleteAlerte(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette alerte ?')) {
                return;
            }

            fetch(`{% url "delete_alerte_api" 0 %}`.replace('0', id), {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert(result.message, 'success');
                    loadAlertes();
                } else {
                    showAlert('Erreur lors de la suppression', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showAlert('Erreur lors de la suppression', 'error');
            });
        }

        // Afficher un message d'alerte
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'} show`;
            alertDiv.textContent = message;
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }

        // Récupérer le token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
